<script>
  // 🔧 Replace with your JSONBin info
  const BIN_ID = "YOUR_BIN_ID";
  const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
  const headers = { 
    "Content-Type": "application/json",
    "X-Master-Key": "YOUR_API_KEY" // optional if private
  };

  const calendarEl = document.getElementById("calendar");
  const totalCheckedEl = document.getElementById("totalChecked");
  const totalMissedEl = document.getElementById("totalMissed");
  const streakEl = document.getElementById("streak");
  const cycleRangeEl = document.getElementById("cycleRange");
  const monthSelect = document.getElementById("monthSelect");
  const yearSelect = document.getElementById("yearSelect");
  const resetBtn = document.getElementById("resetBtn");
  const extendBtn = document.getElementById("extendBtn");
  const syncBtn = document.getElementById("syncBtn");
  const durationSelect = document.getElementById("durationSelect");

  const today = new Date();
  let currentMonth = today.getMonth();
  let currentYear = today.getFullYear();

  // Default data
  let data = { checkins: {}, cycle: null, streak: 0 };

  // ✅ Local storage helpers
  function saveLocal() {
    localStorage.setItem("welkinTracker", JSON.stringify(data));
  }

  function loadLocal() {
    const stored = localStorage.getItem("welkinTracker");
    if (stored) {
      data = JSON.parse(stored);
      console.log("📦 Loaded local data:", data);
    }
  }

  // ✅ JSONBin sync
  async function loadData() {
    try {
      const res = await fetch(BASE_URL + "/latest", { headers });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      data = json.record;
      console.log("☁️ Synced from JSONBin:", data);
      saveLocal(); // update local cache
    } catch (e) {
      console.warn("⚠️ JSONBin not available, using local data:", e);
    }
  }

  async function saveData() {
    try {
      await fetch(BASE_URL, {
        method: "PUT",
        headers,
        body: JSON.stringify(data)
      });
      console.log("☁️ Saved to JSONBin");
    } catch (e) {
      console.warn("⚠️ Failed to save to JSONBin, keeping local:", e);
    }
    saveLocal(); // always update local
  }

  // ✅ UI setup
  function populateSelectors() {
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    monthSelect.innerHTML = "";
    monthNames.forEach((name, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = name;
      if (i === currentMonth) opt.selected = true;
      monthSelect.appendChild(opt);
    });
    yearSelect.innerHTML = "";
    for (let y = currentYear - 5; y <= currentYear + 5; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      if (y === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }
  }

  function renderCalendar() {
    calendarEl.innerHTML = "";
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const checkins = data.checkins?.[`${currentYear}-${currentMonth}`] || {};

    for (let day = 1; day <= daysInMonth; day++) {
      const dayEl = document.createElement("div");
      dayEl.classList.add("day");
      dayEl.textContent = day;

      if (checkins[day]) dayEl.classList.add("checked");

      if (data.cycle?.start && data.cycle?.end) {
        const [sy, sm, sd] = data.cycle.start.split("-").map(Number);
        const [ey, em, ed] = data.cycle.end.split("-").map(Number);
        const startDate = new Date(sy, sm-1, sd);
        const endDate = new Date(ey, em-1, ed);
        const currentDate = new Date(currentYear, currentMonth, day);

        if (currentDate.getTime() === startDate.getTime()) dayEl.classList.add("start");
        if (currentDate.getTime() === endDate.getTime()) dayEl.classList.add("end");
      }

      dayEl.addEventListener("click", () => toggleCheck(day));
      calendarEl.appendChild(dayEl);
    }
    updateStats();
  }

  async function toggleCheck(day) {
    const key = `${currentYear}-${currentMonth}`;
    if (!data.checkins[key]) data.checkins[key] = {};

    if (!data.cycle) {
      const start = `${currentYear}-${currentMonth+1}-${day}`;
      const startDate = new Date(currentYear, currentMonth, day);
      const duration = parseInt(durationSelect.value);
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + duration - 1);
      const end = `${endDate.getFullYear()}-${endDate.getMonth()+1}-${endDate.getDate()}`;
      data.cycle = { start, end };
    }

    if (data.checkins[key][day]) {
      delete data.checkins[key][day];
      if (data.streak > 0) data.streak--;
    } else {
      data.checkins[key][day] = true;
      data.streak++;
    }
    await saveData();
    renderCalendar();
  }

  function updateStats() {
    if (!data.cycle?.start) {
      totalCheckedEl.textContent = "Total Checked-in: 0";
      totalMissedEl.textContent = "Total Missed: 0";
      streakEl.textContent = "Current Streak: " + data.streak;
      cycleRangeEl.textContent = "Cycle: Not started";
      return;
    }

    const [sy, sm, sd] = data.cycle.start.split("-").map(Number);
    const [ey, em, ed] = data.cycle.end.split("-").map(Number);
    const startDate = new Date(sy, sm-1, sd);
    const endDate = new Date(ey, em-1, ed);
    const today = new Date();
    today.setHours(0,0,0,0);

    let checked = 0, missed = 0;
    const current = new Date(startDate);

    while (current <= endDate) {
      const y = current.getFullYear();
      const m = current.getMonth();
      const d = current.getDate();
      const key = `${y}-${m}`;
      const checkins = data.checkins[key] || {};

      if (current < today) {
        if (checkins[d]) checked++; else missed++;
      } else if (current.getTime() === today.getTime()) {
        if (checkins[d]) checked++;
      }
      current.setDate(current.getDate() + 1);
    }

    let daysLeft = Math.max(0, Math.ceil((endDate - today) / (1000*60*60*24)) + 1);
    const todayKey = `${today.getFullYear()}-${today.getMonth()}`;
    if (data.checkins[todayKey] && data.checkins[todayKey][today.getDate()]) daysLeft--;

    totalCheckedEl.textContent = "Total Checked-in: " + checked;
    totalMissedEl.textContent = "Total Missed: " + missed;
    streakEl.textContent = "Current Streak: " + data.streak;
    cycleRangeEl.textContent = `Cycle: ${data.cycle.start} → ${data.cycle.end} | Days Left: ${daysLeft}`;
  }

  // ✅ Button events
  resetBtn.addEventListener("click", async () => {
    if (confirm("Reset cycle? This will clear all check-ins, start, end, and streak.")) {
      data = { checkins: {}, cycle: null, streak: 0 };
      await saveData();
      renderCalendar();
    }
  });

  extendBtn.addEventListener("click", async () => {
    if (!data.cycle) { alert("No active cycle to extend."); return; }
    const duration = parseInt(durationSelect.value);
    const [ey, em, ed] = data.cycle.end.split("-").map(Number);
    let endDate = new Date(ey, em-1, ed);
    endDate.setDate(endDate.getDate() + duration);
    data.cycle.end = `${endDate.getFullYear()}-${endDate.getMonth()+1}-${endDate.getDate()}`;
    await saveData();
    renderCalendar();
  });

  syncBtn.addEventListener("click", async () => {
    await loadData();
    renderCalendar();
    alert("Data synced from server!");
  });

  monthSelect.addEventListener("change", e => { currentMonth = parseInt(e.target.value); renderCalendar(); });
  yearSelect.addEventListener("change", e => { currentYear = parseInt(e.target.value); renderCalendar(); });

  // ✅ Startup
  (async () => {
    loadLocal(); // load from localStorage first
    await loadData(); // then try sync from JSONBin
    populateSelectors();
    renderCalendar();
  })();

  // 🔄 Auto-sync every 5 min
  setInterval(async () => {
    await loadData();
    renderCalendar();
    console.log("Auto-synced from server");
  }, 5 * 60 * 1000);
</script>
