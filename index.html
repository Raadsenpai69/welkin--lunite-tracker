<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Welkin/Lunite Tracker (Cloud Enabled)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 { text-align: center; }
    .controls {
      text-align: center;
      margin-bottom: 15px;
    }
    select, button {
      padding: 6px 12px;
      font-size: 16px;
      border-radius: 6px;
      margin: 4px;
      cursor: pointer;
    }
    button {
      background: #ff5252;
      color: #fff;
      border: none;
    }
    button:hover { opacity: 0.85; }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      max-width: 600px;
      margin: 20px auto;
    }
    .day {
      background: #fff;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
    }
    .day.checked {
      background: #4caf50; color: #fff; border-color: #4caf50;
    }
    .day.start {
      background: #2196f3; color: #fff; border-color: #2196f3;
    }
    .day.end {
      background: #1565c0; color: #fff; border-color: #1565c0;
    }
    .day:hover { transform: scale(1.05); }
    .stats {
      max-width: 600px;
      margin: 20px auto;
      padding: 15px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .stats p { margin: 8px 0; }
  </style>
</head>
<body>
  <h1>Welkin/Lunite Tracker (Cloud Enabled)</h1>

  <div class="controls">
    <select id="monthSelect"></select>
    <select id="yearSelect"></select>
    <select id="durationSelect">
      <option value="30">30 days</option>
      <option value="60">60 days</option>
      <option value="90">90 days</option>
      <option value="120">120 days</option>
    </select>
    <button id="extendBtn">Extend Cycle</button>
    <button id="resetBtn">Reset Cycle</button>
  </div>

  <div class="calendar" id="calendar"></div>

  <div class="stats">
    <h2>Statistics</h2>
    <p id="totalChecked">Total Checked-in: 0</p>
    <p id="totalMissed">Total Missed: 0</p>
    <p id="streak">Current Streak: 0</p>
    <p id="cycleRange">Cycle: Not started</p>
  </div>

  <script type="module">
    // --- Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

   const firebaseConfig = {
  apiKey: "AIzaSyCUFPclKoarfmkgwF-UAqeeUcd8uTJMcc8",
  authDomain: "welkin--lunite-tracker.firebaseapp.com",
  projectId: "welkin--lunite-tracker",
  storageBucket: "welkin--lunite-tracker.firebasestorage.app",
  messagingSenderId: "363360135710",
  appId: "1:363360135710:web:2110f0e0987d49c197dc0f",
  measurementId: "G-85E322B6RL"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const calendarEl = document.getElementById("calendar");
    const totalCheckedEl = document.getElementById("totalChecked");
    const totalMissedEl = document.getElementById("totalMissed");
    const streakEl = document.getElementById("streak");
    const cycleRangeEl = document.getElementById("cycleRange");
    const monthSelect = document.getElementById("monthSelect");
    const yearSelect = document.getElementById("yearSelect");
    const resetBtn = document.getElementById("resetBtn");
    const extendBtn = document.getElementById("extendBtn");
    const durationSelect = document.getElementById("durationSelect");

    const today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();

    // --- Storage helpers ---
    function getStorageKey(year, month) {
      return `welkinCheckins-${year}-${month}`;
    }

    async function saveCheckins(year, month, data) {
      try { await setDoc(doc(db, "checkins", `${year}-${month}`), data); }
      catch(e){ console.error("Firestore save failed, fallback to local", e); }
      localStorage.setItem(getStorageKey(year, month), JSON.stringify(data));
    }

    async function loadCheckins(year, month) {
      try {
        const snap = await getDoc(doc(db, "checkins", `${year}-${month}`));
        if (snap.exists()) return snap.data();
      } catch(e) { console.warn("Firestore load failed", e); }
      return JSON.parse(localStorage.getItem(getStorageKey(year, month))) || {};
    }

    async function saveCycle(data) {
      try { await setDoc(doc(db, "meta", "cycle"), data); }
      catch(e){ console.error("Firestore save failed, fallback to local", e); }
      localStorage.setItem("welkinCycle", JSON.stringify(data));
    }

    async function loadCycle() {
      try {
        const snap = await getDoc(doc(db, "meta", "cycle"));
        if (snap.exists()) return snap.data();
      } catch(e) { console.warn("Firestore load failed", e); }
      return JSON.parse(localStorage.getItem("welkinCycle")) || null;
    }

    async function clearCycle() {
      try { await setDoc(doc(db, "meta", "cycle"), {}); }
      catch(e){ console.error("Firestore clear failed", e); }
      localStorage.removeItem("welkinCycle");
    }

    // --- State ---
    let checkins = await loadCheckins(currentYear, currentMonth);
    let cycle = await loadCycle();
    let streak = parseInt(localStorage.getItem("welkinStreak")) || 0;

    // --- UI Logic ---
    function populateSelectors() {
      const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      monthSelect.innerHTML = "";
      monthNames.forEach((name, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = name;
        if (i === currentMonth) opt.selected = true;
        monthSelect.appendChild(opt);
      });
      yearSelect.innerHTML = "";
      for (let y = currentYear - 5; y <= currentYear + 5; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }
    }

    async function renderCalendar() {
      calendarEl.innerHTML = "";
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      checkins = await loadCheckins(currentYear, currentMonth);

      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement("div");
        dayEl.classList.add("day");
        dayEl.textContent = day;

        const dateStr = `${currentYear}-${currentMonth+1}-${day}`;
        if (checkins[day]) dayEl.classList.add("checked");

        if (cycle) {
          const [sy, sm, sd] = cycle.start.split("-").map(Number);
          const [ey, em, ed] = cycle.end.split("-").map(Number);
          const startDate = new Date(sy, sm-1, sd);
          const endDate = new Date(ey, em-1, ed);
          const currentDate = new Date(currentYear, currentMonth, day);

          if (currentDate.getTime() === startDate.getTime()) dayEl.classList.add("start");
          if (currentDate.getTime() === endDate.getTime()) dayEl.classList.add("end");
        }

        dayEl.addEventListener("click", () => toggleCheck(day, dateStr));
        calendarEl.appendChild(dayEl);
      }
      updateStats();
    }

    async function toggleCheck(day, dateStr) {
      if (!cycle) {
        const start = dateStr;
        const startDate = new Date(currentYear, currentMonth, day);
        const duration = parseInt(durationSelect.value);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + duration - 1);
        const end = `${endDate.getFullYear()}-${endDate.getMonth()+1}-${endDate.getDate()}`;
        cycle = {start, end};
        await saveCycle(cycle);
      }

      if (checkins[day]) {
        delete checkins[day];
        if (streak > 0) streak--;
      } else {
        checkins[day] = true;
        streak++;
      }
      await saveCheckins(currentYear, currentMonth, checkins);
      localStorage.setItem("welkinStreak", streak);
      renderCalendar();
    }

    async function updateStats() {
      if (!cycle) {
        totalCheckedEl.textContent = "Total Checked-in: 0";
        totalMissedEl.textContent = "Total Missed: 0";
        streakEl.textContent = "Current Streak: " + streak;
        cycleRangeEl.textContent = "Cycle: Not started";
        return;
      }

      const [sy, sm, sd] = cycle.start.split("-").map(Number);
      const [ey, em, ed] = cycle.end.split("-").map(Number);
      const startDate = new Date(sy, sm-1, sd);
      const endDate = new Date(ey, em-1, ed);
      const today = new Date(); today.setHours(0,0,0,0);

      let checked = 0, missed = 0, totalDays = 0;
      const current = new Date(startDate);
      while (current <= endDate) {
        const y = current.getFullYear();
        const m = current.getMonth();
        const d = current.getDate();
        const data = await loadCheckins(y, m);

        if (current < today) {
          if (data[d]) checked++; else missed++;
        } else if (current.getTime() === today.getTime()) {
          if (data[d]) checked++;
        }

        totalDays++;
        current.setDate(current.getDate() + 1);
      }

      let daysLeft = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)) + 1);
      const todayData = await loadCheckins(today.getFullYear(), today.getMonth());
      if (todayData[today.getDate()]) daysLeft--;

      totalCheckedEl.textContent = "Total Checked-in: " + checked;
      totalMissedEl.textContent = "Total Missed: " + missed;
      streakEl.textContent = "Current Streak: " + streak;
      cycleRangeEl.textContent = `Cycle: ${cycle.start} → ${cycle.end} | Days Left: ${daysLeft}`;
    }

    resetBtn.addEventListener("click", async () => {
      if (confirm("Reset cycle? This will clear all check-ins, start, end, and streak.")) {
        cycle = null; streak = 0;
        await clearCycle();
        localStorage.setItem("welkinStreak", 0);

        // Clear all local check-ins
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith("welkinCheckins-")) keysToRemove.push(key);
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));

        renderCalendar();
      }
    });

    extendBtn.addEventListener("click", async () => {
      if (!cycle) { alert("No active cycle to extend."); return; }
      const duration = parseInt(durationSelect.value);
      const [ey, em, ed] = cycle.end.split("-").map(Number);
      let endDate = new Date(ey, em-1, ed);
      endDate.setDate(endDate.getDate() + duration);
      cycle.end = `${endDate.getFullYear()}-${endDate.getMonth()+1}-${endDate.getDate()}`;
      await saveCycle(cycle);
      renderCalendar();
    });

    monthSelect.addEventListener("change", (e) => {
      currentMonth = parseInt(e.target.value);
      renderCalendar();
    });
    yearSelect.addEventListener("change", (e) => {
      currentYear = parseInt(e.target.value);
      renderCalendar();
    });

    populateSelectors();
    renderCalendar();
  </script>
</body>
</html>
