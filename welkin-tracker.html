<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Welkin Moon Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    .controls {
      text-align: center;
      margin-bottom: 15px;
    }
    select, button {
      padding: 6px 12px;
      font-size: 16px;
      border-radius: 6px;
      margin: 4px;
      cursor: pointer;
    }
    button {
      background: #ff5252;
      color: #fff;
      border: none;
    }
    button:hover {
      opacity: 0.85;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      max-width: 600px;
      margin: 20px auto;
    }
    .day {
      background: #fff;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
    }
    .day.checked {
      background: #4caf50; /* green */
      color: #fff;
      border-color: #4caf50;
    }
    .day.start {
      background: #2196f3; /* blue */
      color: #fff;
      border-color: #2196f3;
    }
    .day.end {
      background: #1565c0; /* dark blue */
      color: #fff;
      border-color: #1565c0;
    }
    .day:hover {
      transform: scale(1.05);
    }
    .stats {
      max-width: 600px;
      margin: 20px auto;
      padding: 15px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .stats p {
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <h1>Welkin Moon Tracker</h1>

  <div class="controls">
    <select id="monthSelect"></select>
    <select id="yearSelect"></select>
    <button id="resetBtn">Reset Cycle</button>
  </div>

  <div class="calendar" id="calendar"></div>

  <div class="stats">
    <h2>Statistics</h2>
    <p id="totalChecked">Total Checked-in: 0</p>
    <p id="totalMissed">Total Missed: 0</p>
    <p id="streak">Current Streak: 0</p>
    <p id="cycleRange">Cycle: Not started</p>
  </div>

  <script>
    const calendarEl = document.getElementById("calendar");
    const totalCheckedEl = document.getElementById("totalChecked");
    const totalMissedEl = document.getElementById("totalMissed");
    const streakEl = document.getElementById("streak");
    const cycleRangeEl = document.getElementById("cycleRange");
    const monthSelect = document.getElementById("monthSelect");
    const yearSelect = document.getElementById("yearSelect");
    const resetBtn = document.getElementById("resetBtn");

    const today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();

    // --- Storage helpers ---
    function getStorageKey(year, month) {
      return `welkinCheckins-${year}-${month}`;
    }
    function loadCheckins(year, month) {
      return JSON.parse(localStorage.getItem(getStorageKey(year, month))) || {};
    }
    function saveCheckins(year, month, data) {
      localStorage.setItem(getStorageKey(year, month), JSON.stringify(data));
    }
    function loadCycle() {
      return JSON.parse(localStorage.getItem("welkinCycle")) || null;
    }
    function saveCycle(data) {
      localStorage.setItem("welkinCycle", JSON.stringify(data));
    }
    function clearCycle() {
      localStorage.removeItem("welkinCycle");
    }

    let checkins = loadCheckins(currentYear, currentMonth);
    let cycle = loadCycle(); // {start: "YYYY-MM-DD", end: "YYYY-MM-DD"}
    let streak = parseInt(localStorage.getItem("welkinStreak")) || 0;

    // --- Dropdowns ---
    function populateSelectors() {
      const monthNames = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];
      monthSelect.innerHTML = "";
      monthNames.forEach((name, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = name;
        if (i === currentMonth) opt.selected = true;
        monthSelect.appendChild(opt);
      });
      yearSelect.innerHTML = "";
      for (let y = currentYear - 5; y <= currentYear + 5; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }
    }

    // --- Calendar ---
    function renderCalendar() {
      calendarEl.innerHTML = "";
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      checkins = loadCheckins(currentYear, currentMonth);

      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement("div");
        dayEl.classList.add("day");
        dayEl.textContent = day;

        const dateStr = `${currentYear}-${currentMonth+1}-${day}`;

        if (checkins[day]) dayEl.classList.add("checked");

        if (cycle) {
          const [sy, sm, sd] = cycle.start.split("-").map(Number);
          const [ey, em, ed] = cycle.end.split("-").map(Number);
          const startDate = new Date(sy, sm-1, sd);
          const endDate = new Date(ey, em-1, ed);
          const currentDate = new Date(currentYear, currentMonth, day);

          if (currentDate.getTime() === startDate.getTime()) dayEl.classList.add("start");
          if (currentDate.getTime() === endDate.getTime()) dayEl.classList.add("end");
        }

        dayEl.addEventListener("click", () => toggleCheck(day, dateStr));
        calendarEl.appendChild(dayEl);
      }
      updateStats();
    }

    function toggleCheck(day, dateStr) {
      if (!cycle) {
        // First check-in sets start & end of cycle
        const start = dateStr;
        const startDate = new Date(currentYear, currentMonth, day);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 29);

        const end = `${endDate.getFullYear()}-${endDate.getMonth()+1}-${endDate.getDate()}`;
        cycle = {start, end};
        saveCycle(cycle);
      }

      if (checkins[day]) {
        delete checkins[day];
        if (streak > 0) streak--;
      } else {
        checkins[day] = true;
        streak++;
      }
      saveCheckins(currentYear, currentMonth, checkins);
      localStorage.setItem("welkinStreak", streak);
      renderCalendar();
    }

    function updateStats() {
      if (!cycle) {
        totalCheckedEl.textContent = "Total Checked-in: 0";
        totalMissedEl.textContent = "Total Missed: 0";
        streakEl.textContent = "Current Streak: " + streak;
        cycleRangeEl.textContent = "Cycle: Not started";
        return;
      }

      const [sy, sm, sd] = cycle.start.split("-").map(Number);
      const [ey, em, ed] = cycle.end.split("-").map(Number);
      const startDate = new Date(sy, sm-1, sd);
      const endDate = new Date(ey, em-1, ed);

      let checked = 0;
      let totalDays = 0;

      const current = new Date(startDate);
      while (current <= endDate) {
        const y = current.getFullYear();
        const m = current.getMonth();
        const d = current.getDate();
        const data = loadCheckins(y, m);
        if (data[d]) checked++;
        totalDays++;
        current.setDate(current.getDate() + 1);
      }

      const missed = totalDays - checked;

      totalCheckedEl.textContent = "Total Checked-in: " + checked;
      totalMissedEl.textContent = "Total Missed: " + missed;
      streakEl.textContent = "Current Streak: " + streak;
      cycleRangeEl.textContent = `Cycle: ${cycle.start} â†’ ${cycle.end}`;
    }

    // --- Reset ---
    resetBtn.addEventListener("click", () => {
      if (confirm("Reset cycle? This will clear start, end, and streak.")) {
        cycle = null;
        streak = 0;
        clearCycle();
        localStorage.setItem("welkinStreak", 0);
        renderCalendar();
      }
    });

    // --- Events ---
    monthSelect.addEventListener("change", (e) => {
      currentMonth = parseInt(e.target.value);
      renderCalendar();
    });
    yearSelect.addEventListener("change", (e) => {
      currentYear = parseInt(e.target.value);
      renderCalendar();
    });

    // --- Init ---
    populateSelectors();
    renderCalendar();
  </script>
</body>
</html>
